@using ToDoApp
@using ToDoApp.Components
@using ToDoApp.Components.Layout
@using ToDoApp.Components.Pages
@using ToDoApp.Components.Helpers
@using ToDoApp.Domain

<li class="list-group-item d-flex justify-content-between align-items-center">
    @if (isEditing)
    {
        @* --- 編集中 --- *@
        <div class="input-group input-group-sm">
            <input @bind="editingTitle" class="form-control" />
            <button class="btn btn-success" @onclick="SaveEdit">保存</button>
        </div>
    }
    else
    {
        @* --- 通常時 --- *@
        <div class="d-flex align-items-center">
            <input type="checkbox" class="form-check-input me-2" @bind="Item.IsDone" @bind:after="NotifyUpdate" />

            @* ▼▼▼ UIHelperを使ってバッジを表示 ▼▼▼ *@
            <span class="badge @UIHelper.GetPriorityBadgeClass(Item.Priority) me-2">@Item.Priority</span>

            <span style="@(Item.IsDone ? "text-decoration: line-through;" : "")">@Item.Title</span>
        </div>
        <div class="d-flex align-items-center">
            <button class="btn btn-sm btn-outline-primary me-2" @onclick="StartEditing">編集</button>
            <button class="btn btn-sm btn-outline-danger" @onclick="() => OnDeleteClicked.InvokeAsync(Item)">削除</button>
        </div>
    }
</li>

@code {
    [Parameter]
    public TodoItem Item { get; set; } = new();

    [Parameter]
    public EventCallback<TodoItem> OnDeleteClicked { get; set; }
    
    [Parameter]
    public EventCallback<TodoItem> OnUpdateClicked { get; set; }

    private bool isEditing = false;
    private string editingTitle = string.Empty;

    private void StartEditing()
    {
        isEditing = true;
        editingTitle = Item.Title ?? string.Empty;
    }

    private async Task SaveEdit()
    {
        Item.Title = editingTitle;
        isEditing = false;
        await OnUpdateClicked.InvokeAsync(Item);
    }
    
    // チェックボックスの状態が変わった後にも更新を通知する
    private async Task NotifyUpdate()
    {
        await OnUpdateClicked.InvokeAsync(Item);
    }
    // 優先度表示を追加
    private string GetPriorityBadgeClass(TaskPriority priority)
    {
        return priority switch
        {
            TaskPriority.High => "bg-danger",
            TaskPriority.Medium => "bg-warning text-dark",
            TaskPriority.Low => "bg-secondary",
            _ => "bg-light text-dark"
        };
    }
}