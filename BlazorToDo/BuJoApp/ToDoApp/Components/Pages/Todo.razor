@page "/todo"
@rendermode InteractiveServer
@using ToDoApp.Data
@using ToDoApp.Components
@using System.IO
@using System.Text.Json

@* ▼▼▼ 全体をcontainerで囲み、タイトルを追加 ▼▼▼ *@
<div class="container mt-4">
    <h1 class="mb-4">Daily ToDo List</h1>

    @* ▼▼▼ 入力フォームをcardで囲む ▼▼▼ *@
    <div class="card bg-light mb-4">
        <div class="card-body">
            <h5 class="card-title">新しいタスクの追加</h5>
            <div class="input-group">
                <input type="date" class="form-control" @bind="newTaskDate" />
                <input @bind="newTodoTitle" @bind:event="oninput" class="form-control" placeholder="タスクの内容" />
                <button class="btn btn-primary" @onclick="AddTodo">追加</button>
            </div>
        </div>
    </div>

    @* ▼▼▼ 日毎のリスト表示部分を修正 ▼▼▼ *@
    @foreach (var dayGroup in todos.GroupBy(t => t.Date).OrderByDescending(g => g.Key))
    {
        <div class="mb-3">
            <h4>@dayGroup.Key.ToLongDateString()</h4>
            @* ▼▼▼ ulタグにlist-groupクラスを追加 ▼▼▼ *@
            <ul class="list-group">
                @foreach (var todo in dayGroup)
                {
                    <TodoItemDisplay Item="todo" OnDeleteClicked="RemoveTodo" />
                }
            </ul>
        </div>
    }
</div>


@code {
    // C#のコード部分は変更ありません
    private List<TodoItem> todos = new();
    private string? newTodoTitle;
    private DateOnly newTaskDate = DateOnly.FromDateTime(DateTime.Now);
    
    private const string FilePath = "todos.json";

    protected override async Task OnInitializedAsync()
    {
        await LoadTodosFromFile();
    }

    private async Task LoadTodosFromFile()
    {
        if (File.Exists(FilePath))
        {
            var json = await File.ReadAllTextAsync(FilePath);
            var loadedTodos = JsonSerializer.Deserialize<List<TodoItem>>(json);
            if (loadedTodos is not null)
            {
                todos = loadedTodos;
            }
        }
    }

    private async Task SaveTodosToFile()
    {
        var json = JsonSerializer.Serialize(todos);
        await File.WriteAllTextAsync(FilePath, json);
    }

    private async Task AddTodo()
    {
        if (!string.IsNullOrWhiteSpace(newTodoTitle))
        {
            var newItem = new TodoItem 
            { 
                Title = newTodoTitle, 
                IsDone = false,
                Date = newTaskDate
            };
            todos.Add(newItem);
            newTodoTitle = string.Empty;
            await SaveTodosToFile();
        }
    }

    private async Task RemoveTodo(TodoItem todoToRemove)
    {
        todos.Remove(todoToRemove);
        await SaveTodosToFile();
    }
}